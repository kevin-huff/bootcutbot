<!DOCTYPE html>
<html>
<head>
    <title>Dice Roll Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="lcars.css">
  	<link rel="stylesheet" type="text/css" href="lcars-colors.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="description" content="With our advanced roll tracking technology we can provide realtime dice stats for every roll of the dice in Abbabox's interactive boadgame of Bootcut">
    <meta name="keywords" content="Bootcut Queue, Abbabox, Gaming, Queue, Turns, Twitch, Interactive Boardgame">
    <style>
    #stats {
      margin: 20px 0;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 4px;
      line-height: 1.5;
    }
    #stats strong {
      color: #007bff;
    }
  </style>

</head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5JXPYNCK9Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5JXPYNCK9Q');
</script>
<body>
	<section class="wrap-standard" id="column-3">
		<div class="wrap">
			<div class="scroll-top"><a id="scroll-top" href=""><span class="hop">screen</span> top</a></div>
			<div class="left-frame-top">
				<div class="panel-1"><img src="<%= banner_image %>" alt="Abbabox twitch channel logo"></div>
				<div class="panel-2">02<span class="hop">-262000</span></div>
			</div>
			<div class="right-frame-top">
				<div class="banner">Abbabox &#149; 
          <span class="blink">Dice DB</span>
        </div>
				<div class="data-cascade-button-group">
					<div class="cascade-wrapper">
						<div class="data-cascade" id="default">
							<div class="row-1"><div class="dc1">101</div><div class="dc2">7109</div><div class="dc3">1966</div><div class="dc44">36</div><div class="dc55">880</div><div class="dc6">11.03</div><div class="dc77">1954</div><div class="dc8">03</div><div class="dc99">6.08</div><div class="dc100">241</div><div class="dc11">309</div><div class="dc12">7.08</div><div class="dc13">1935</div><div class="dc14">12.20</div><div class="dc150">53</div><div class="dc150">1961</div><div class="dc150">2.16</div></div><div class="row-2"><div class="dc1">102</div><div class="dc2">8102</div><div class="dc3">1987</div><div class="dc44">044</div><div class="dc55">0051</div><div class="dc6">1968</div><div class="dc77">704</div><div class="dc8">10.31</div><div class="dc99">1984</div><div class="dc100">1954</div><div class="dc11">764</div><div class="dc12">1940</div><div class="dc13">9.9</div><div class="dc14">1972</div><div class="dc150">815</div><div class="dc150">4.12</div><div class="dc150">2023</div></div><div class="row-3"><div class="dc1">103</div><div class="dc2">714</div><div class="dc3">1993</div><div class="dc44">0222</div><div class="dc55">4.4</div><div class="dc6">1969</div><div class="dc77">2450</div><div class="dc8">91</div><div class="dc99">56</div><div class="dc100">24</div><div class="dc11">716</div><div class="dc12">801</div><div class="dc13">417</div><div class="dc14">602</div><div class="dc150">5618</div><div class="dc150">238</div><div class="dc150">1443</div></div><div class="row-4"><div class="dc1">104</div><div class="dc2">6104</div><div class="dc3">1995</div><div class="dc44">3.22</div><div class="dc55">1931</div><div class="dc6">0.0</div><div class="dc77">0000</div><div class="dc8">1701</div><div class="dc99">1984</div><div class="dc100">218</div><div class="dc11">908</div><div class="dc12">10</div><div class="dc13">85</div><div class="dc14">1888</div><div class="dc150">27</div><div class="dc150">2879</div><div class="dc150">213</div></div><div class="row-5"><div class="dc1">105</div><div class="dc2">08</div><div class="dc3">2001</div><div class="dc44">713</div><div class="dc55">079</div><div class="dc6">1977</div><div class="dc77">LV</div><div class="dc8">426</div><div class="dc99">105</div><div class="dc100">10</div><div class="dc11">1642</div><div class="dc12">1979</div><div class="dc13">402</div><div class="dc14">795</div><div class="dc150">361</div><div class="dc150">0852</div><div class="dc150">984</div></div><div class="row-6"><div class="dc1">106</div><div class="dc2">31</div><div class="dc3">2017</div><div class="dc44">429</div><div class="dc55">65</div><div class="dc6">871</div><div class="dc77">24</div><div class="dc8">541</div><div class="dc99">656</div><div class="dc100">M</div><div class="dc11">113</div><div class="dc12">12.6</div><div class="dc13">27</div><div class="dc14">05</div><div class="dc150">85</div><div class="dc150">12.25</div><div class="dc150">7884</div></div><div class="row-7"><div class="dc1">107</div><div class="dc2">5</div><div class="dc3">2022</div><div class="dc44">784</div><div class="dc55">3304</div><div class="dc6">42</div><div class="dc77">733</div><div class="dc8">1224</div><div class="dc99">5801</div><div class="dc100">23</div><div class="dc11">1015</div><div class="dc12">84</div><div class="dc13">36</div><div class="dc14">029</div><div class="dc150">24</div><div class="dc150">318</div><div class="dc150">12.24</div></div><div class="row-8"><div class="dc1">108</div><div class="dc2">23</div><div class="dc3">174</div><div class="dc44">91</div><div class="dc55">947</div><div class="dc6">28</div><div class="dc77">527</div><div class="dc8">04</div><div class="dc99">0469</div><div class="dc100">2200</div><div class="dc11">88</div><div class="dc12">1985</div><div class="dc13">540</div><div class="dc14">3121</div><div class="dc150">308</div><div class="dc150">9571</div><div class="dc150">404</div></div>
						</div>
					</div>
					<nav id="nav-standard"> 
						<a href="/" id="b-one">The Queue</a>
						<a href="/splot_db" id="b-two">Splots DB</a>
						<a href="/ratings" id="b-three">Ratings DB</a>
						<a href="/menu" target="_BLANK" id="b-five">Command Menu</a>
					</nav>
				</div>
				<div class="bar-panel first-bar-panel">
					<div class="bar-1"></div>
					<div class="bar-2"></div>
					<div class="bar-3"></div>
					<div class="bar-4"></div>
					<div class="bar-5"></div>
				</div>
			</div>
		</div>
		<div class="wrap" id="gap">
			<div class="left-frame">
				<div>
					<div class="panel-3">03<span class="hop">-USS Bootcut</span></div>
					<div class="panel-4">04<span class="hop">-041969</span></div>
					<div class="panel-5">05<span class="hop">-1701D</span></div>
					<div class="panel-6">06<span class="hop">-071984</span></div>
					<div class="panel-7">07<span class="hop">-081940</span></div>
					<div class="panel-8">08<span class="hop">-47148</span></div>
					<div class="panel-9">09<span class="hop">-081966</span></div>
				</div>
				<div>
					<div class="panel-10">10<span class="hop">-31</span></div>
				</div>
			</div>
			<div class="right-frame">
				<div class="bar-panel">
					<div class="bar-6"></div>
					<div class="bar-7"></div>
					<div class="bar-8"></div>
					<div class="bar-9"></div>
					<div class="bar-10"></div>
				</div>
				<main>

					<!-- Start your content here. -->

					<h1>Dice Roll Analysis</h1>
		      <p>
            This page tracks the dice rolls during bootcut. All dice rolls are automaticlly logged and stats are updated as the game progresses.
          </p>
          <div class="lcars-text-bar">
            <span>Roll Data</span>
          </div>
          <h2 id="sessionDate" class="text-center mb-4"></h2>
          <div class="flexbox">
          <div class="col">
            <div class="d-flex justify-content-between">
              <p id="turns"></p>
              <p id="totalRolls"></p>
            </div>
            <div class="d-flex justify-content-between">
              <p id="d6Rolls"></p>
              <p id="d12Rolls"></p>
            </div>
            <div class="d-flex justify-content-between">
              <p id="successfulBAs"></p>
              <p id="hostageRolls"></p>
            </div>
            <div class="d-flex justify-content-between">
              <p id="worstSplotNum"></p>
              <p id="bestSplotNum"></p>
            </div>
            <div class="form-group">
              <label for="sessionSelect">Change Session:</label>
              <select id="sessionSelect" class="form-control"></select>
            </div>
          </div>
          <div class="col">
        <canvas id="baDiceChart"></canvas>
        <canvas id="boardDiceChart"></canvas>
          </div>
      </div>

					<footer>
						<div class="footer-inside">
							<div class="footer-text">
    <div class="footer-grid">
        <div class="footer-column">
          <!-- Content -->
          <h5 class="text-uppercase">Support Abbabox</h5>
          <p>Help the streamer keep doing the things. Support him anyway you can.</p>
        </div>
        <div class="footer-column">
         <!-- Links -->
        <h5 class="text-uppercase">Social</h5>

        <ul class="list-unstyled">
          <ol>
            <a href="https://twitch.com/abbabox">Twitch</a>
          </ol>
          <ol>
            <a href="https://twitter.com/abbabox1">Twitter</a>
          </ol>
          <ol>
            <a href="https://www.youtube.com/c/Abbabox">YouTube</a>
          </ol>
          <ol>
            <a href="https://discord.com/invite/vgB85mF">Discord</a>
          </ol>
          <ol>
            <a href="https://www.tiktok.com/@abbabox?lang=en">TikTok</a>
          </ol>
          <ol>
            <a href="https://instagram.com/abbaboxtv/">Instagram</a>
          </ol>
        </ul>

        </div>
        <div class="footer-column">
                  <!-- Links -->
        <h5 class="text-uppercase">Pay the Man</h5>

        <ul class="list-unstyled">
          <ol>
            <a href="https://streamlabs.com/abbabox/tip">Paypal</a>
          </ol>
          <ol>
            <a href="https://www.streamloots.com/abbabox">StreamLoots</a>
          </ol>
          <ol>
            <a href="https://jointhrone.com/u/abbabox">Throne</a>
          </ol>
          <ol>
            <a href="https://streamlabs.com/abbabox/merch">Merch</a>
          </ol>
        </ul>
      </div>
    </div>
					</div>
						</div>
						<div class="footer-panel"> <span class="hop">22</span>47 </div>
					</footer>
				</main>
			</div>
		</div>
	</section>	
	<script type="text/javascript" src="lcars.js"></script>
 <script>
    let sessions = [];
    let currentSessionIndex = 0;
    let boardDiceChart, baDiceChart;

    async function getDiceRollData() {
      const url = "/dice_log.json";
      const response = await axios.get(url);
      return response.data.dice_roll;
    }

    function groupRollsBySession(rolls) {
      const sortedRolls = _.orderBy(rolls, roll => moment(roll.timestamp, 'MM/DD/YYYY, h:mm:ss A'), 'asc');
      let currentSession = [];
      for (let i = 0; i < sortedRolls.length; i++) {
        if (i === 0 || moment(sortedRolls[i].timestamp, 'MM/DD/YYYY, h:mm:ss A').diff(moment(sortedRolls[i - 1].timestamp, 'MM/DD/YYYY, h:mm:ss A'), 'hours') < 12) {
          currentSession.push(sortedRolls[i]);
        } else {
          sessions.push(currentSession);
          currentSession = [sortedRolls[i]];
        }
      }
      if (currentSession.length > 0) {
        sessions.push(currentSession);
      }
      
      sessions = _.reverse(sessions);
      updateSessionSelect();

    }
    function analyzeSession(session) {
      let totalRolls = 0;
      let d6Rolls = 0;
      let d12Rolls = 0;
      let successfulBAs = 0;
      let hostageRolls = 0;
      let splotNumCounts = {};
      let baNumCounts = {};
      let worstSplotNum, bestSplotNum;
      let d6Name, d12Name;
      let lastRollTimestamp = null;
      let turns = 0;
      
      session.forEach(roll => {
        totalRolls++;

        if (!d6Name && roll.dice_type === 'D6') {
          d6Name = roll.dice_name;
        }

        if (!d12Name && roll.dice_type === 'D12') {
          d12Name = roll.dice_name;
        }

        if (roll.dice_type === 'D6') {
          d6Rolls++;
          baNumCounts[roll.roll_value] = (baNumCounts[roll.roll_value] || 0) + 1;

          if (roll.roll_value == 1 || roll.roll_value == 6) {
            successfulBAs++;
          }

          if (roll.roll_value == 3) {
            hostageRolls++;
          }
        }

        if (roll.dice_type === 'D12') {
          d12Rolls++;
          splotNumCounts[roll.roll_value] = (splotNumCounts[roll.roll_value] || 0) + 1;
        }
      });
      // sort session by timestamp
        let sortedSession = _.sortBy(session, 'timestamp');

        sortedSession.forEach(roll => {
          if (roll.dice_type === 'D12') {
            let currentRollTimestamp = new Date(roll.timestamp);
            if (lastRollTimestamp !== null) {
              let diffMinutes = (currentRollTimestamp - lastRollTimestamp) / 1000 / 60;
              if (diffMinutes >= 2) { // change this value to adjust the threshold
                turns++;
              }
            } else {
              // This is the first D12 roll of the session
              turns++;
            }
            lastRollTimestamp = currentRollTimestamp;
          }
        });
      worstSplotNum = _.minBy(Object.keys(splotNumCounts), function (num) { return splotNumCounts[num]; });
      bestSplotNum = _.maxBy(Object.keys(splotNumCounts), function (num) { return splotNumCounts[num]; });
      let sessionDate = new Date(session[0].timestamp).toLocaleDateString();
      document.getElementById('sessionDate').textContent = `Session Date: ${sessionDate}`;

      updateStats(turns, totalRolls, d6Rolls, d12Rolls, successfulBAs, hostageRolls, worstSplotNum, bestSplotNum);
      updateChart('boardDiceChart', Object.keys(splotNumCounts), Object.values(splotNumCounts));
      updateChart('baDiceChart', Object.keys(baNumCounts), Object.values(baNumCounts));
    }

    function updateStats(turns, totalRolls, d6Rolls, d12Rolls, successfulBAs, hostageRolls, worstSplotNum, bestSplotNum) {
      document.getElementById('turns').textContent = `Turns: ${turns}`;
      document.getElementById('totalRolls').textContent = `Dice Rolls (total): ${totalRolls}`;
      document.getElementById('d6Rolls').textContent = `Dice Rolls (D6): ${d6Rolls}`;
      document.getElementById('d12Rolls').textContent = `Dice Rolls (D12): ${d12Rolls}`;
      document.getElementById('successfulBAs').textContent = `Successful BA's: ${successfulBAs}`;
      document.getElementById('hostageRolls').textContent = `Hostage Rolls: ${hostageRolls}`;
      document.getElementById('worstSplotNum').textContent = `Worst Splot Num: ${worstSplotNum}`;
      document.getElementById('bestSplotNum').textContent = `Best Splot Num: ${bestSplotNum}`;
    }

    function updateChart(chartId, labels, data) {
      let chart;
      let chartLabel;

      if (chartId === 'boardDiceChart') {
        chart = boardDiceChart;
        chartLabel = 'Board Die';
      } else {
        chart = baDiceChart;
        chartLabel = 'BreakAway Die';
      }
      console.log(chartLabel);
      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.options.plugins.title.text = chartLabel;
        chart.update();
      } else {
        let ctx = document.getElementById(chartId).getContext('2d');
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '# of Rolls',
              data: data,
              backgroundColor: 'rgba(119, 136, 255, 1)',  // Change this to your preferred color
              borderColor: 'rgba(119, 136, 255, 1)',
              borderWidth: 1
            }]
          },
          options: {
            plugins: {
                title: {
                    display: true,
                    text: chartLabel
                }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });

        if (chartId === 'boardDiceChart') {
          boardDiceChart = chart;
        } else {
          baDiceChart = chart;
        }
      }
    }

    function updateSessionSelect() {
      const selectElement = document.getElementById('sessionSelect');
      selectElement.innerHTML = '';
      sessions.forEach((session, index) => {
        const optionElement = document.createElement('option');
        optionElement.value = index;
        optionElement.textContent = new Date(session[0].timestamp).toLocaleDateString();
        selectElement.appendChild(optionElement);
      });
    }

   
    document.getElementById('sessionSelect').addEventListener('change', function(e) {
      currentSessionIndex = e.target.value;
      analyzeSession(sessions[currentSessionIndex]);
    });

    (async function() {
      const rolls = await getDiceRollData();
      groupRollsBySession(rolls);
      analyzeSession(sessions[currentSessionIndex]);
    })();
  </script>
</body>

</html>
  
  